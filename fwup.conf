# fwup.conf - Rock 5T Firmware Configuration (GPT)
#
# Partition layout for 64GB eMMC using GPT
# Leaves first 16MB for bootloader (idbloader + u-boot)
#
# CRITICAL: Radxa BSP U-Boot requires GPT partition table, not MBR

meta-product = "Rock 5T Nerves"
meta-description = "Nerves firmware for Radxa Rock 5T"
meta-version = "${NERVES_FW_VERSION}"
meta-platform = "rock5t"
meta-architecture = "aarch64"
meta-author = "vidarh"
meta-creation-date = "${NERVES_FW_CREATION_DATE}"
meta-uuid = "${NERVES_FW_UUID}"

# eMMC device path for OTA upgrades
define(NERVES_FW_DEVPATH, "/dev/mmcblk0")

# Firmware archive files
require-fwup-version="1.0.0"

# Partition layout offsets (in 512-byte sectors)
# Leave first 16MB for bootloader
define(UBOOT_OFFSET, 64)           # 32KB offset for idbloader
define(UBOOT_ITB_OFFSET, 16384)    # 8MB offset for u-boot.itb
define(UBOOT_ENV_OFFSET, 32768)    # 16MB for U-Boot env
define(UBOOT_ENV_COUNT, 256)       # 128KB for env

# Boot partition starts at 32MB (after bootloader area)
define(BOOT_A_PART_OFFSET, 65536)    # 32MB start
define(BOOT_A_PART_COUNT, 131072)    # 64MB boot partition

define(BOOT_B_PART_OFFSET, 196608)   # 96MB start
define(BOOT_B_PART_COUNT, 131072)    # 64MB boot partition

# Rootfs partitions doubled from 512MB to 1024MB (2026-02-08)
# This accommodates Mesa with GPU/NPU drivers and Chromium
define(ROOTFS_A_PART_OFFSET, 327680)  # 160MB start
define(ROOTFS_A_PART_COUNT, 2097152)  # 1024MB rootfs (was 512MB)

define(ROOTFS_B_PART_OFFSET, 2424832) # 1184MB start (160MB + 1024MB)
define(ROOTFS_B_PART_COUNT, 2097152)  # 1024MB rootfs (was 512MB)

# Application data partition
# eMMC is 58GB (122,142,720 sectors), not 64GB
# Layout: 160MB boot area + 2x1024MB rootfs = 2208MB used
# Available: 122,142,720 - 4,521,984 = 117,620,736 sectors
define(APP_PART_OFFSET, 4521984)      # 2208MB start (was 1184MB)
define(APP_PART_COUNT, 117000000)     # ~55.5GB (fits 58GB eMMC)

# GPT Partition Type GUIDs
# EBD0A0A2-B9E5-4433-87C0-68B6B72699C7 = Microsoft Basic Data (for FAT)
# 0FC63DAF-8483-4772-8E79-3D69D8477DE4 = Linux filesystem
define(LINUX_FILESYSTEM_DATA_TYPE, "0fc63daf-8483-4772-8e79-3d69d8477de4")
define(BASIC_DATA_TYPE, "ebd0a0a2-b9e5-4433-87c0-68b6b72699c7")

# File resources
file-resource idbloader.img {
    host-path = "${NERVES_SYSTEM}/images/idbloader.img"
}

file-resource u-boot.itb {
    host-path = "${NERVES_SYSTEM}/images/u-boot.itb"
}

file-resource Image {
    host-path = "${NERVES_SYSTEM}/images/Image"
}

file-resource rk3588-rock-5t.dtb {
    host-path = "${NERVES_SYSTEM}/images/rk3588-rock-5t.dtb"
}

file-resource rootfs.img {
    host-path = "${ROOTFS}"
    assert-size-lte = ${ROOTFS_A_PART_COUNT}
}

file-resource boot.scr {
    host-path = "${NERVES_SYSTEM}/images/boot.scr"
}

# GPT partition table - Slot A active
gpt gpt-a {
    # Disk GUID (randomly generated, fixed for this firmware)
    guid = "b443fbeb-2c93-481b-88b3-0ecb0aaaaaa1"

    # Boot A partition (FAT32 for kernel, dtb, boot.scr)
    partition 0 {
        block-offset = ${BOOT_A_PART_OFFSET}
        block-count = ${BOOT_A_PART_COUNT}
        type = ${BASIC_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a01"
        name = "boot"
        boot = true
    }
    # Rootfs A partition (SquashFS)
    partition 1 {
        block-offset = ${ROOTFS_A_PART_OFFSET}
        block-count = ${ROOTFS_A_PART_COUNT}
        type = ${LINUX_FILESYSTEM_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a02"
        name = "rootfs-a"
    }
    # Rootfs B partition (SquashFS)
    partition 2 {
        block-offset = ${ROOTFS_B_PART_OFFSET}
        block-count = ${ROOTFS_B_PART_COUNT}
        type = ${LINUX_FILESYSTEM_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a03"
        name = "rootfs-b"
    }
    # Application data partition (ext4, formatted on first boot)
    partition 3 {
        block-offset = ${APP_PART_OFFSET}
        block-count = ${APP_PART_COUNT}
        type = ${LINUX_FILESYSTEM_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a04"
        name = "app-data"
    }
}

# GPT partition table - Slot B active
gpt gpt-b {
    # Disk GUID (same as gpt-a to maintain disk identity)
    guid = "b443fbeb-2c93-481b-88b3-0ecb0aaaaaa1"

    # Boot B partition (FAT32 for kernel, dtb, boot.scr)
    # Note: Different offset/guid than gpt-a boot partition
    partition 0 {
        block-offset = ${BOOT_B_PART_OFFSET}
        block-count = ${BOOT_B_PART_COUNT}
        type = ${BASIC_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a11"
        name = "boot"
        boot = true
    }
    # Rootfs A partition (SquashFS) - same as gpt-a
    partition 1 {
        block-offset = ${ROOTFS_A_PART_OFFSET}
        block-count = ${ROOTFS_A_PART_COUNT}
        type = ${LINUX_FILESYSTEM_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a02"
        name = "rootfs-a"
    }
    # Rootfs B partition (SquashFS) - same as gpt-a
    partition 2 {
        block-offset = ${ROOTFS_B_PART_OFFSET}
        block-count = ${ROOTFS_B_PART_COUNT}
        type = ${LINUX_FILESYSTEM_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a03"
        name = "rootfs-b"
    }
    # Application data partition (ext4, formatted on first boot) - same as gpt-a
    partition 3 {
        block-offset = ${APP_PART_OFFSET}
        block-count = ${APP_PART_COUNT}
        type = ${LINUX_FILESYSTEM_DATA_TYPE}
        guid = "5278721d-0089-4768-85df-b8f1b97a6a04"
        name = "app-data"
    }
}

# U-Boot environment block
uboot-environment uboot-env {
    block-offset = ${UBOOT_ENV_OFFSET}
    block-count = ${UBOOT_ENV_COUNT}
}

# Complete installation task (initial flash)
task complete {
    on-init {
        gpt_write(gpt-a)
        uboot_clearenv(uboot-env)

        uboot_setenv(uboot-env, "nerves_fw_active", "a")
        uboot_setenv(uboot-env, "nerves_fw_devpath", ${NERVES_FW_DEVPATH})
        uboot_setenv(uboot-env, "nerves_fw_validated", "0")
        uboot_setenv(uboot-env, "nerves_fw_booted", "0")
        uboot_setenv(uboot-env, "a.nerves_fw_uuid", "\${NERVES_FW_UUID}")
        uboot_setenv(uboot-env, "a.nerves_fw_product", "\${NERVES_FW_PRODUCT}")
        uboot_setenv(uboot-env, "a.nerves_fw_description", "\${NERVES_FW_DESCRIPTION}")
        uboot_setenv(uboot-env, "a.nerves_fw_version", "\${NERVES_FW_VERSION}")
        uboot_setenv(uboot-env, "a.nerves_fw_platform", "\${NERVES_FW_PLATFORM}")
        uboot_setenv(uboot-env, "a.nerves_fw_architecture", "\${NERVES_FW_ARCHITECTURE}")
        uboot_setenv(uboot-env, "a.nerves_fw_author", "\${NERVES_FW_AUTHOR}")

        fat_mkfs(${BOOT_A_PART_OFFSET}, ${BOOT_A_PART_COUNT})
        fat_setlabel(${BOOT_A_PART_OFFSET}, "BOOT-A")
    }

    on-resource idbloader.img {
        raw_write(${UBOOT_OFFSET})
    }

    on-resource u-boot.itb {
        raw_write(${UBOOT_ITB_OFFSET})
    }

    on-resource boot.scr {
        fat_write(${BOOT_A_PART_OFFSET}, "boot.scr")
    }

    on-resource Image {
        fat_write(${BOOT_A_PART_OFFSET}, "Image")
    }

    on-resource rk3588-rock-5t.dtb {
        fat_write(${BOOT_A_PART_OFFSET}, "rk3588-rock-5t.dtb")
    }

    on-resource rootfs.img {
        raw_write(${ROOTFS_A_PART_OFFSET})
    }

    on-finish {
    }
}

# Upgrade slot A
task upgrade.a {
    require-uboot-variable(uboot-env, "nerves_fw_active", "b")

    on-init {
        uboot_setenv(uboot-env, "nerves_fw_devpath", ${NERVES_FW_DEVPATH})
        uboot_setenv(uboot-env, "nerves_fw_validated", "0")
        uboot_setenv(uboot-env, "a.nerves_fw_uuid", "\${NERVES_FW_UUID}")
        uboot_setenv(uboot-env, "a.nerves_fw_product", "\${NERVES_FW_PRODUCT}")
        uboot_setenv(uboot-env, "a.nerves_fw_description", "\${NERVES_FW_DESCRIPTION}")
        uboot_setenv(uboot-env, "a.nerves_fw_version", "\${NERVES_FW_VERSION}")
        uboot_setenv(uboot-env, "a.nerves_fw_platform", "\${NERVES_FW_PLATFORM}")
        uboot_setenv(uboot-env, "a.nerves_fw_architecture", "\${NERVES_FW_ARCHITECTURE}")
        uboot_setenv(uboot-env, "a.nerves_fw_author", "\${NERVES_FW_AUTHOR}")

        fat_mkfs(${BOOT_A_PART_OFFSET}, ${BOOT_A_PART_COUNT})
        fat_setlabel(${BOOT_A_PART_OFFSET}, "BOOT-A")
    }

    on-resource boot.scr {
        fat_write(${BOOT_A_PART_OFFSET}, "boot.scr")
    }

    on-resource Image {
        fat_write(${BOOT_A_PART_OFFSET}, "Image")
    }

    on-resource rk3588-rock-5t.dtb {
        fat_write(${BOOT_A_PART_OFFSET}, "rk3588-rock-5t.dtb")
    }

    on-resource rootfs.img {
        raw_write(${ROOTFS_A_PART_OFFSET})
    }

    on-finish {
        gpt_write(gpt-a)
        uboot_setenv(uboot-env, "nerves_fw_active", "a")
    }
}

# Upgrade slot B
task upgrade.b {
    require-uboot-variable(uboot-env, "nerves_fw_active", "a")

    on-init {
        uboot_setenv(uboot-env, "nerves_fw_devpath", ${NERVES_FW_DEVPATH})
        uboot_setenv(uboot-env, "nerves_fw_validated", "0")
        uboot_setenv(uboot-env, "b.nerves_fw_uuid", "\${NERVES_FW_UUID}")
        uboot_setenv(uboot-env, "b.nerves_fw_product", "\${NERVES_FW_PRODUCT}")
        uboot_setenv(uboot-env, "b.nerves_fw_description", "\${NERVES_FW_DESCRIPTION}")
        uboot_setenv(uboot-env, "b.nerves_fw_version", "\${NERVES_FW_VERSION}")
        uboot_setenv(uboot-env, "b.nerves_fw_platform", "\${NERVES_FW_PLATFORM}")
        uboot_setenv(uboot-env, "b.nerves_fw_architecture", "\${NERVES_FW_ARCHITECTURE}")
        uboot_setenv(uboot-env, "b.nerves_fw_author", "\${NERVES_FW_AUTHOR}")

        fat_mkfs(${BOOT_B_PART_OFFSET}, ${BOOT_B_PART_COUNT})
        fat_setlabel(${BOOT_B_PART_OFFSET}, "BOOT-B")
    }

    on-resource boot.scr {
        fat_write(${BOOT_B_PART_OFFSET}, "boot.scr")
    }

    on-resource Image {
        fat_write(${BOOT_B_PART_OFFSET}, "Image")
    }

    on-resource rk3588-rock-5t.dtb {
        fat_write(${BOOT_B_PART_OFFSET}, "rk3588-rock-5t.dtb")
    }

    on-resource rootfs.img {
        raw_write(${ROOTFS_B_PART_OFFSET})
    }

    on-finish {
        gpt_write(gpt-b)
        uboot_setenv(uboot-env, "nerves_fw_active", "b")
    }
}

# Provisioning task (same as complete but named for clarity)
task provision {
    on-init {
        gpt_write(gpt-a)
        uboot_clearenv(uboot-env)

        uboot_setenv(uboot-env, "nerves_fw_active", "a")
        uboot_setenv(uboot-env, "nerves_fw_validated", "0")
        uboot_setenv(uboot-env, "nerves_fw_booted", "0")
        uboot_setenv(uboot-env, "a.nerves_fw_uuid", "\${NERVES_FW_UUID}")
        uboot_setenv(uboot-env, "a.nerves_fw_product", "\${NERVES_FW_PRODUCT}")
        uboot_setenv(uboot-env, "a.nerves_fw_description", "\${NERVES_FW_DESCRIPTION}")
        uboot_setenv(uboot-env, "a.nerves_fw_version", "\${NERVES_FW_VERSION}")
        uboot_setenv(uboot-env, "a.nerves_fw_platform", "\${NERVES_FW_PLATFORM}")
        uboot_setenv(uboot-env, "a.nerves_fw_architecture", "\${NERVES_FW_ARCHITECTURE}")
        uboot_setenv(uboot-env, "a.nerves_fw_author", "\${NERVES_FW_AUTHOR}")

        fat_mkfs(${BOOT_A_PART_OFFSET}, ${BOOT_A_PART_COUNT})
        fat_setlabel(${BOOT_A_PART_OFFSET}, "BOOT-A")
    }

    on-resource idbloader.img {
        raw_write(${UBOOT_OFFSET})
    }

    on-resource u-boot.itb {
        raw_write(${UBOOT_ITB_OFFSET})
    }

    on-resource boot.scr {
        fat_write(${BOOT_A_PART_OFFSET}, "boot.scr")
    }

    on-resource Image {
        fat_write(${BOOT_A_PART_OFFSET}, "Image")
    }

    on-resource rk3588-rock-5t.dtb {
        fat_write(${BOOT_A_PART_OFFSET}, "rk3588-rock-5t.dtb")
    }

    on-resource rootfs.img {
        raw_write(${ROOTFS_A_PART_OFFSET})
    }

    on-finish {
    }
}
